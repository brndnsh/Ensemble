<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensemble</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="flashOverlay"></div>
<div id="toast">Copied to clipboard!</div>
<header>
    <h1>Ensemble</h1>
    
    <div class="main-controls">
        <button id="playBtn" class="primary-btn">START</button>
        
        <div class="control-group">
            <span class="control-label">BPM</span>
            <input type="number" id="bpmInput" value="100" min="40" max="240">
            <button id="tapBtn" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; height: auto;">TAP</button>
        </div>

        <button id="settingsBtn" style="padding: 0.5rem;" aria-label="Settings">‚öôÔ∏è</button>
    </div>
</header>

<div class="app-main-layout">
    <!-- ARRANGER PANEL -->
    <div class="panel" id="arrangerPanel">
        <div class="panel-header chord-panel-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <h2>Arranger</h2>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button id="maximizeChordBtn" title="Maximize" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" aria-label="Maximize Chords">‚õ∂</button>
                <select id="keySelect" style="width: auto;" aria-label="Select Key">
                    <option value="C">Key: C</option>
                    <option value="Db">Key: Db</option>
                    <option value="D">Key: D</option>
                    <option value="Eb">Key: Eb</option>
                    <option value="E">Key: E</option>
                    <option value="F">Key: F</option>
                    <option value="Gb">Key: Gb</option>
                    <option value="G">Key: G</option>
                    <option value="Ab">Key: Ab</option>
                    <option value="A">Key: A</option>
                    <option value="Bb">Key: Bb</option>
                    <option value="B">Key: B</option>
                </select>
                <button id="transDownBtn" title="Transpose Down" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" aria-label="Transpose Down">‚ô≠</button>
                <button id="transUpBtn" title="Transpose Up" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" aria-label="Transpose Up">‚ôØ</button>
            </div>
        </div>

        <div class="display-area" id="chordVisualizer"></div>
        <div id="activeSectionLabel" class="active-section-label" style="text-align: center; color: var(--accent-color); font-weight: bold; margin-bottom: 0.5rem; height: 1.5rem;"></div>

        <div style="margin-bottom: 1.5rem;">
            <div id="sectionList" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem;"></div>
            <button id="addSectionBtn" style="width: 100%; padding: 0.75rem; border: 1px dashed #475569; background: transparent; color: #94a3b8; cursor: pointer;">+ Add Section</button>
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                <button id="dupMeasureChordBtn" title="Duplicate Measure 1 in Section" style="flex: 1; padding: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; min-width: 80px;" aria-label="Duplicate Measure 1">‚ßâ <span>Dup Bar 1</span></button>
                <button id="randomizeBtn" title="Randomize Progression" style="flex: 1; padding: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; min-width: 80px;" aria-label="Randomize Progression">üé≤ <span>Random</span></button>
                <button id="clearProgBtn" title="Clear Progression" style="flex: 1; padding: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; min-width: 80px;" aria-label="Clear Progression">üóëÔ∏è <span>Clear</span></button>
                <button id="saveBtn" title="Save Progression" style="flex: 1; padding: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; min-width: 80px;" aria-label="Save Progression">üíæ <span>Save</span></button>
                <button id="shareBtn" title="Share Progression" style="flex: 1; padding: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; min-width: 80px;" aria-label="Share Progression">üîó <span>Share</span></button>
            </div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 0.5rem; min-height: 100px;">
            <label style="font-size: 0.9rem; color: #94a3b8;">Library</label>
            <div class="presets-container" id="chordPresets" style="margin-top: 0.5rem;"></div>
            <div class="presets-container" id="userPresetsContainer" style="border-top: 1px solid #334155; padding-top: 0.5rem; display: none;"></div>
        </div>
    </div>

    <!-- ACCOMPANIST PANEL -->
    <div class="panel" id="accompanistPanel">
        <div class="panel-header">
            <h2>Accompanist</h2>
        </div>

        <div class="tabs">
            <div class="tab-item">
                <button class="tab-btn active" data-tab="chords">Chords</button>
                <button id="chordPowerBtn" class="power-btn active" aria-label="Toggle Chords">‚èª</button>
            </div>
            <div class="tab-item">
                <button class="tab-btn" data-tab="grooves">Grooves</button>
                <button id="groovePowerBtn" class="power-btn active" aria-label="Toggle Grooves">‚èª</button>
            </div>
            <div class="tab-item">
                <button class="tab-btn" data-tab="bass">Bass</button>
                <button id="bassPowerBtn" class="power-btn" aria-label="Toggle Bassist">‚èª</button>
            </div>
            <div class="tab-item">
                <button class="tab-btn" data-tab="soloist">Soloist</button>
                <button id="soloistPowerBtn" class="power-btn" aria-label="Toggle Soloist">‚èª</button>
            </div>
        </div>

        <!-- CHORDS TAB -->
        <div class="tab-content active" id="tab-chords">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #94a3b8;">Style</label>
                <div class="presets-container" id="chordStylePresets"></div>
            </div>

            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 0.9rem; color: var(--accent-color);">Voicing</h4>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem;">Density</label>
                    <select id="densitySelect" style="width: 100%;" aria-label="Voicing Density">
                        <option value="thin">Thin (3 notes)</option>
                        <option value="standard" selected>Standard (4 notes)</option>
                        <option value="rich">Rich (5+ notes)</option>
                    </select>
                </div>
                <div>
                    <label style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Register</span>
                        <span id="octaveLabel" style="color: var(--accent-color); font-weight: bold;">F4</span>
                    </label>
                    <input type="range" id="octaveSlider" min="32" max="92" value="65" style="width: 100%;" aria-label="Chord Octave">
                </div>
            </div>
        </div>

        <!-- BASS TAB -->
        <div class="tab-content" id="tab-bass">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #94a3b8;">Style</label>
                <div class="presets-container" id="bassStylePresets"></div>
            </div>

            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 0.9rem; color: var(--accent-color);">Instrument</h4>
                <div>
                    <label style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Register</span>
                        <span id="bassOctaveLabel" style="color: var(--accent-color); font-weight: bold;">F2</span>
                    </label>
                    <input type="range" id="bassOctaveSlider" min="24" max="60" value="41" style="width: 100%;" aria-label="Bass Octave">
                </div>
                <div style="text-align: right; margin-top: 0.5rem;">
                     <span id="bassHeaderReg" style="display:none;"></span>
                </div>
            </div>
        </div>

        <!-- SOLOIST TAB -->
        <div class="tab-content" id="tab-soloist">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #94a3b8;">Style</label>
                <div class="presets-container" id="soloistStylePresets"></div>
            </div>

             <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 0.9rem; color: var(--accent-color);">Instrument</h4>
                <div>
                    <label style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Register</span>
                        <span id="soloistOctaveLabel" style="color: var(--accent-color); font-weight: bold;">F5</span>
                    </label>
                    <input type="range" id="soloistOctaveSlider" min="48" max="91" value="77" style="width: 100%;" aria-label="Soloist Octave">
                </div>
                 <div style="text-align: right; margin-top: 0.5rem;">
                     <span id="soloistHeaderReg" style="display:none;"></span>
                </div>
            </div>
        </div>

        <!-- GROOVES TAB -->
        <div class="tab-content" id="tab-grooves">
            <div class="sequencer-grid" id="sequencerGrid"></div>
            
             <div style="margin-bottom: 1rem; margin-top: 0.5rem;">
                <div style="font-size: 0.8rem; color: #64748b; font-style: italic; margin-bottom: 0.5rem;">Tap steps to create your own beat...</div>
                <div class="presets-container" id="drumPresets"></div>
                <div class="presets-container" id="userDrumPresetsContainer" style="border-top: 1px solid #334155; padding-top: 0.5rem; display: none;"></div>
            </div>

            <div style="margin-top: 1rem; border-top: 1px solid #334155; padding-top: 1rem;">
                <div style="display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
                    <div style="flex: 1 1 200px;">
                        <label class="control-label" style="display: block; margin-bottom: 0.4rem;">Swing</label>
                        <div style="display: flex; gap: 0.4rem; align-items: center;">
                            <input type="range" id="swingSlider" min="0" max="100" value="0" style="flex-grow: 1; height: 4px;" aria-label="Swing Amount">
                            <select id="swingBaseSelect" style="width: 65px; font-size: 0.75rem; padding: 0.2rem; height: 28px;" aria-label="Swing Base Note">
                                <option value="16th">1/16</option>
                                <option value="8th" selected>1/8</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="control-label" style="display: block; margin-bottom: 0.4rem;">Actions</label>
                        <div style="display: flex; gap: 0.5rem; height: 32px;">
                            <button id="clearDrumsBtn" style="font-size: 0.75rem; padding: 0 1rem; height: 100%;">Clear</button>
                            <button id="saveDrumBtn" title="Save Pattern" style="font-size: 0.75rem; padding: 0 1rem; height: 100%;">üíæ Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISUALIZER PANEL -->
    <div class="panel panel-disabled" id="visualizerPanel">
        <div class="panel-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button id="vizPowerBtn" class="power-btn" aria-label="Toggle Visualizer">‚èª</button>
                <h2>Unified Visualizer</h2>
            </div>
        </div>
        
        <div style="flex-grow: 1; min-height: 350px; position: relative; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
            <div id="unifiedVizContainer" style="width: 100%; height: 100%;"></div>
        </div>

        <div class="viz-legend">
            <div class="legend-item">
                <div class="legend-swatch swatch-root"></div>
                <span>Root</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch swatch-third"></div>
                <span>3rd</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch swatch-fifth"></div>
                <span>5th</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch swatch-seventh"></div>
                <span>7th+</span>
            </div>
            <div class="legend-item" style="margin-left: auto;">
                <div class="legend-swatch swatch-bass"></div>
                <span>Bass</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch swatch-soloist"></div>
                <span>Soloist</span>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsOverlay">
    <div class="settings-content">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2>Settings</h2>
            <button id="closeSettingsBtn" style="background: none; border: none; font-size: 1.5rem;" aria-label="Close Settings">&times;</button>
        </div>
        
        <div class="settings-controls">
            <div class="settings-section">
                <h3>Mixer</h3>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Master Volume</span>
                    </label>
                    <input type="range" id="masterVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Master Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Chord Volume</span>
                    </label>
                    <input type="range" id="chordVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Chord Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Bass Volume</span>
                    </label>
                    <input type="range" id="bassVolume" min="0" max="1" step="0.05" value="0.45" style="width: 100%;" aria-label="Bass Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Soloist Volume</span>
                    </label>
                    <input type="range" id="soloistVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Soloist Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Drum Volume</span>
                    </label>
                    <input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Drum Volume">
                </div>
            </div>

            <div class="settings-section">
                <h3>Reverb</h3>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Chord Reverb</span>
                    </label>
                    <input type="range" id="chordReverb" min="0" max="1" step="0.05" value="0.3" style="width: 100%;" aria-label="Chord Reverb">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Bass Reverb</span>
                    </label>
                    <input type="range" id="bassReverb" min="0" max="1" step="0.05" value="0.05" style="width: 100%;" aria-label="Bass Reverb">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Soloist Reverb</span>
                    </label>
                    <input type="range" id="soloistReverb" min="0" max="1" step="0.05" value="0.6" style="width: 100%;" aria-label="Soloist Reverb">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Drum Reverb</span>
                    </label>
                    <input type="range" id="drumReverb" min="0" max="1" step="0.05" value="0.2" style="width: 100%;" aria-label="Drum Reverb">
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="countInCheck" checked>
                    Count-in (4 Beats)
                </label>
            </div>

            <div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="visualFlashCheck">
                    Visual Flash
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="hapticCheck">
                    Haptic
                </label>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Notation</label>
                <select id="notationSelect" style="width: 100%;" aria-label="Chord Notation">
                    <option value="roman">Roman Numerals (I, vi, IV)</option>
                    <option value="name">Chord Names (C, Am, F)</option>
                    <option value="nns">Nashville Numbers (1, 6-, 4)</option>
                </select>
            </div>
            
            <div class="setting-item" style="margin-top: 1rem;">
                <button id="exportMidiBtn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: var(--panel-color); border: 1px solid #475569;">
                    <span>üéπ</span> Export Progression as MIDI
                </button>
            </div>
            <div class="setting-item" style="margin-top: 0.5rem;">
                <button id="resetSettingsBtn" style="width: 100%; color: var(--error-color); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">Reset All Settings</button>
            </div>
        </div>

        <div class="settings-help" style="margin-top: 1rem; border-top: 1px solid #334155; padding-top: 1rem; border-top: none;">
            <details open>
                <summary style="cursor: pointer; font-weight: bold; color: var(--text-primary); list-style: none; display: flex; align-items: center; justify-content: space-between;">
                    <span>Help & Instructions</span>
                    <span style="font-size: 0.8em;">‚ñº</span>
                </summary>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                    <div style="margin-bottom: 1.5rem; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                        <h4 style="color: var(--accent-color); margin-top: 0; margin-bottom: 0.5rem;">Need more help?</h4>
                        <p style="margin-bottom: 0.8rem;">For a deep dive into notation, soloing styles, and MIDI export, check out the full manual.</p>
                        <a href="manual.html" target="_blank" style="color: white; background: var(--accent-color); padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: bold; display: inline-block;">Open User Manual</a>
                    </div>
                </div>
            </details>
        </div>
    </div>
</div>

<script type="module" src="main.js"></script>
</body>
</html>