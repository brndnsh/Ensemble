<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensemble</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg" sizes="any">
    <link rel="apple-touch-icon" href="icon.svg">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="flashOverlay"></div>
<div id="toast">Copied to clipboard!</div>
<header>
    <h1>Ensemble</h1>
    
    <div class="main-controls">
        <button id="playBtn" class="primary-btn">START</button>
        
        <div class="control-group">
            <span class="control-label">BPM</span>
            <input type="number" id="bpmInput" value="100" min="40" max="240">
            <button id="tapBtn" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; height: auto;">TAP</button>
        </div>

        <button id="settingsBtn" style="padding: 0.5rem;" aria-label="Settings">‚öôÔ∏è</button>
    </div>
</header>

<div class="app-container">
    <!-- CHORD PANEL -->
    <div class="panel" id="chordPanel">
        <div class="panel-header chord-panel-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button id="chordPowerBtn" class="power-btn active" aria-label="Toggle Chords">‚èª</button>
                <h2>Chords</h2>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button id="maximizeChordBtn" title="Maximize" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" aria-label="Maximize Chords">‚õ∂</button>
                <select id="keySelect" style="width: auto;" aria-label="Select Key">
                    <option value="C">Key: C</option>
                    <option value="Db">Key: Db</option>
                    <option value="D">Key: D</option>
                    <option value="Eb">Key: Eb</option>
                    <option value="E">Key: E</option>
                    <option value="F">Key: F</option>
                    <option value="Gb">Key: Gb</option>
                    <option value="G">Key: G</option>
                    <option value="Ab">Key: Ab</option>
                    <option value="A">Key: A</option>
                    <option value="Bb">Key: Bb</option>
                    <option value="B">Key: B</option>
                </select>
                <button id="transDownBtn" title="Transpose Down" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" aria-label="Transpose Down">‚ô≠</button>
                <button id="transUpBtn" title="Transpose Up" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" aria-label="Transpose Up">‚ôØ</button>
            </div>
        </div>

        <div class="display-area" id="chordVisualizer"></div>

        <div style="margin-bottom: 1.5rem; height: 42px;">
            <div style="display: flex; gap: 0.5rem; height: 100%;">
                <input type="text" id="progressionInput" value="I | V | vi | IV" placeholder="Progression (e.g., I | V | vi | IV)" aria-label="Chord Progression">
                <button id="saveBtn" title="Save Progression" style="width: auto; padding: 0.5rem 1rem;" aria-label="Save Progression">üíæ</button>
                <button id="shareBtn" title="Share Progression" style="width: auto; padding: 0.5rem 1rem;" aria-label="Share Progression">üîó</button>
            </div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 0.5rem; min-height: 100px;">
            <div class="presets-container" id="chordPresets"></div>
            <div class="presets-container" id="userPresetsContainer" style="border-top: 1px solid #334155; padding-top: 0.5rem; display: none;"></div>
        </div>

        <div style="margin-top: 1.5rem; border-top: 1px solid #334155; padding-top: 1rem;">
            <label style="font-size: 0.9rem; color: #94a3b8;">Style</label>
            <div class="presets-container" id="chordStylePresets" style="margin-top: 0.5rem;"></div>
        </div>
    </div>

    <!-- GROOVE PANEL -->
    <div class="panel" id="groovePanel">
        <div class="panel-header groove-panel-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button id="groovePowerBtn" class="power-btn active" aria-label="Toggle Grooves">‚èª</button>
                <h2>Grooves</h2>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="control-group">
                    <span class="control-label" style="font-size: 0.7rem;">Bars</span>
                    <select id="drumBarsSelect" style="width: 40px; border: none; background: transparent; font-size: 0.9rem; padding: 0; color: white;" aria-label="Number of Bars">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="4">4</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="sequencer-grid" id="sequencerGrid">
            <!-- Filled by JS -->
        </div>

        <div style="margin-bottom: 1.5rem; height: 42px; display: flex; align-items: center;">
            <div style="font-size: 0.8rem; color: #64748b; font-style: italic;">Tap steps to create your own beat...</div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 0.5rem; min-height: 100px;">
            <div class="presets-container" id="drumPresets"></div>
            <div class="presets-container" id="userDrumPresetsContainer" style="border-top: 1px solid #334155; padding-top: 0.5rem; display: none;"></div>
        </div>

        <div style="margin-top: 1.5rem; border-top: 1px solid #334155; padding-top: 1rem;">
            <div style="display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
                <div style="flex: 1 1 200px;">
                    <label class="control-label" style="display: block; margin-bottom: 0.4rem;">Swing</label>
                    <div style="display: flex; gap: 0.4rem; align-items: center;">
                        <input type="range" id="swingSlider" min="0" max="100" value="0" style="flex-grow: 1; height: 4px;" aria-label="Swing Amount">
                        <select id="swingBaseSelect" style="width: 65px; font-size: 0.75rem; padding: 0.2rem; height: 28px;" aria-label="Swing Base Note">
                            <option value="16th">1/16</option>
                            <option value="8th" selected>1/8</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="control-label" style="display: block; margin-bottom: 0.4rem;">Actions</label>
                    <div style="display: flex; gap: 0.5rem; height: 32px;">
                        <button id="clearDrumsBtn" style="font-size: 0.75rem; padding: 0 1rem; height: 100%;">Clear</button>
                        <button id="saveDrumBtn" title="Save Pattern" style="font-size: 0.75rem; padding: 0 1rem; height: 100%;">üíæ Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BASSIST PANEL -->
    <div class="panel" id="bassPanel">
        <div class="panel-header bass-panel-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button id="bassPowerBtn" class="power-btn active" aria-label="Toggle Bassist">‚èª</button>
                <h2>Bassist</h2>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="control-group">
                    <span class="control-label" style="font-size: 0.7rem;">Reg</span>
                    <span id="bassHeaderReg" style="font-size: 0.9rem; color: white; min-width: 25px; text-align: center; font-weight: bold;">F2</span>
                </div>
            </div>
        </div>
        
        <div class="display-area" id="bassVisualizer" style="display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden; padding: 0;">
             <div style="display: flex; align-items: baseline; justify-content: center; z-index: 2; margin-top: 10px;">
                <div id="bassNoteName" style="font-size: 4rem; font-weight: 800; font-family: serif; color: var(--accent-color); text-shadow: 0 0 20px rgba(59, 130, 246, 0.4);">--</div>
                <div id="bassNoteOctave" style="font-size: 1.5rem; color: #64748b; font-weight: bold; margin-left: 2px;"></div>
             </div>
             <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; z-index: 1;">
                <svg id="bassGraph" viewBox="0 0 100 100" preserveAspectRatio="none" style="display: block; width: 100%; height: 100%;">
                    <g id="bassChordTones"></g>
                    <polyline id="bassPolyline" points="" fill="none" stroke="var(--accent-color)" stroke-width="3" stroke-opacity="0.8" stroke-linejoin="round" />
                </svg>
             </div>
        </div>

        <div style="margin-bottom: 1.5rem; height: 42px; display: flex; align-items: center;">
            <div style="font-size: 0.8rem; color: #64748b; font-style: italic;">Walking Bass Generator follows your chords...</div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 0.5rem; min-height: 40px;">
            <!-- Placeholder for potential future presets -->
        </div>

        <div style="margin-top: 1.5rem; border-top: 1px solid #334155; padding-top: 1rem;">
            <label style="font-size: 0.9rem; color: #94a3b8;">Style</label>
            <div class="presets-container" id="bassStylePresets" style="margin-top: 0.5rem;"></div>
        </div>
    </div>

    <!-- SOLOIST PANEL -->
    <div class="panel" id="soloistPanel">
        <div class="panel-header soloist-panel-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button id="soloistPowerBtn" class="power-btn" aria-label="Toggle Soloist">‚èª</button>
                <h2>Soloist</h2>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="control-group">
                    <span class="control-label" style="font-size: 0.7rem;">Reg</span>
                    <span id="soloistHeaderReg" style="font-size: 0.9rem; color: white; min-width: 25px; text-align: center; font-weight: bold;">F5</span>
                </div>
            </div>
        </div>
        
        <div class="display-area" id="soloistVisualizer" style="display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden; padding: 0;">
             <div style="display: flex; align-items: baseline; justify-content: center; z-index: 2; margin-top: 10px;">
                <div id="soloistNoteName" style="font-size: 4rem; font-weight: 800; font-family: serif; color: #f472b6; text-shadow: 0 0 20px rgba(244, 114, 182, 0.4);">--</div>
                <div id="soloistNoteOctave" style="font-size: 1.5rem; color: #64748b; font-weight: bold; margin-left: 2px;"></div>
             </div>
             <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; z-index: 1;">
                <svg id="soloistGraph" viewBox="0 0 100 100" preserveAspectRatio="none" style="display: block; width: 100%; height: 100%;">
                    <g id="soloistChordTones"></g>
                    <path id="soloistPath" d="" fill="none" stroke="var(--soloist-color)" stroke-width="3" stroke-opacity="0.8" stroke-linejoin="round" stroke-linecap="round" />
                </svg>
             </div>
        </div>

        <div style="margin-bottom: 1.5rem; height: 42px; display: flex; align-items: center;">
            <div style="font-size: 0.8rem; color: #64748b; font-style: italic;">Soloist generates melodic lines over your progression...</div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 0.5rem; min-height: 40px;">
        </div>

        <div style="margin-top: 1.5rem; border-top: 1px solid #334155; padding-top: 1rem;">
            <label style="font-size: 0.9rem; color: #94a3b8;">Style</label>
            <div class="presets-container" id="soloistStylePresets" style="margin-top: 0.5rem;"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsOverlay">
    <div class="settings-content">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <h2>Settings</h2>
            <button id="closeSettingsBtn" style="background: none; border: none; font-size: 1.5rem;" aria-label="Close Settings">&times;</button>
        </div>
        
        <div class="settings-controls">
            <div class="settings-section">
                <h3>Mixer</h3>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Master Volume</span>
                    </label>
                    <input type="range" id="masterVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Master Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Chord Volume</span>
                    </label>
                    <input type="range" id="chordVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Chord Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Bass Volume</span>
                    </label>
                    <input type="range" id="bassVolume" min="0" max="1" step="0.05" value="0.5" style="width: 100%;" aria-label="Bass Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Soloist Volume</span>
                    </label>
                    <input type="range" id="soloistVolume" min="0" max="1" step="0.05" value="0.4" style="width: 100%;" aria-label="Soloist Volume">
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <span>Drum Volume</span>
                    </label>
                    <input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.6" style="width: 100%;" aria-label="Drum Volume">
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="countInCheck" checked>
                    Count-in (4 Beats)
                </label>
            </div>

            <div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="visualFlashCheck">
                    Visual Flash
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="hapticCheck">
                    Haptic
                </label>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Notation</label>
                <select id="notationSelect" style="width: 100%;" aria-label="Chord Notation">
                    <option value="roman">Roman Numerals (I, vi, IV)</option>
                    <option value="name">Chord Names (C, Am, F)</option>
                    <option value="nns">Nashville Numbers (1, 6-, 4)</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Chord Voicing Register</span>
                    <span id="octaveLabel" style="color: var(--accent-color); font-weight: bold;">F4</span>
                </label>
                <input type="range" id="octaveSlider" min="32" max="92" value="65" style="width: 100%;" aria-label="Chord Octave">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Bass Register</span>
                    <span id="bassOctaveLabel" style="color: var(--accent-color); font-weight: bold;">F2</span>
                </label>
                <input type="range" id="bassOctaveSlider" min="24" max="60" value="41" style="width: 100%;" aria-label="Bass Octave">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Soloist Register</span>
                    <span id="soloistOctaveLabel" style="color: var(--accent-color); font-weight: bold;">F5</span>
                </label>
                <input type="range" id="soloistOctaveSlider" min="48" max="96" value="77" style="width: 100%;" aria-label="Soloist Octave">
            </div>

            <div style="margin-top: 1rem; border-top: 1px solid #334155; padding-top: 1rem;">
                <button id="resetSettingsBtn" style="width: 100%; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: var(--error-color);">Reset to Defaults</button>
            </div>
        </div>

        <div class="settings-help" style="margin-top: 1rem; border-top: 1px solid #334155; padding-top: 1rem; border-top: none;">
            <details open>
                <summary style="cursor: pointer; font-weight: bold; color: var(--text-primary); list-style: none; display: flex; align-items: center; justify-content: space-between;">
                    <span>Help & Instructions</span>
                    <span style="font-size: 0.8em;">‚ñº</span>
                </summary>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">üéπ Chords</h4>
                        <p>Enter progressions using three flexible notations. You can separate chords with spaces or use <code>|</code> to denote measures (each measure defaults to 4 beats).</p>
                        
                        <ul style="margin-left: 1.2rem; margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.4rem;">
                            <li><strong>Roman Numerals:</strong> Use <code>I, IV, V, vi, ii</code>. Uppercase for major, lowercase for minor (e.g., <code>I vi IV V</code>).</li>
                            <li><strong>Nashville Numbers:</strong> Use <code>1, 4, 5, 6-, 2-</code>. Add <code>-</code> for minor (e.g., <code>1 6- 4 5</code>).</li>
                            <li><strong>Chord Names:</strong> Use standard names like <code>C, Am, F, G, Bb</code>.</li>
                        </ul>

                        <p style="margin-top: 0.8rem;"><strong>Supported Qualities:</strong></p>
                        <ul style="margin-left: 1.2rem; margin-top: 0.3rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem;">
                            <li><code>7</code>: Dominant 7th</li>
                            <li><code>maj7</code>: Major 7th</li>
                            <li><code>m, min, -</code>: Minor</li>
                            <li><code>m7</code>: Minor 7th</li>
                            <li><code>dim, o</code>: Diminished</li>
                            <li><code>m7b5, √∏</code>: Half-dim</li>
                            <li><code>aug, +</code>: Augmented</li>
                            <li><code># / b</code>: Accidentals</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ü•Å Grooves</h4>
                        <p>Tap grid steps to program beats. Each row represents a drum (Kick, Snare, HiHat, Open Hat). Use the <strong>Bars</strong> selector to change pattern length.</p>
                        <p style="margin-top: 0.3rem;"><strong>Swing:</strong> Adjust the slider to add a "shuffle" feel. Choose between 1/8 or 1/16 note swing bases.</p>
                    </div>

                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">‚å®Ô∏è Shortcuts & Tips</h4>
                        <ul style="margin-left: 1.2rem; display: flex; flex-direction: column; gap: 0.2rem;">
                            <li><code>Space</code>: Start / Stop playback.</li>
                            <li><code>‚õ∂</code>: Maximize chord display (ideal for practice).</li>
                            <li><code>üîó</code>: Copy a shareable URL of your current setup.</li>
                            <li><code>üíæ</code>: Save your custom progressions or drum beats.</li>
                        </ul>
                    </div>
                </div>
            </details>
        </div>
    </div>
</div>

<script type="module" src="main.js"></script>
</body>
</html>